<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- import CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<body>
  <div id="app">
    <el-container>
      <el-header>
        <el-row :gutter="20">
          <el-col :span="17">
            <el-steps :active="active" finish-status="success">
              <el-step title="选课"></el-step>
              <el-step title="安排教学计划"></el-step>
              <el-step title="生成课表"></el-step>
            </el-steps>
          </el-col>
          <el-col :span="5">
              <el-button-group>
                <el-button :disabled="frontButton" type="primary" icon="el-icon-arrow-left" @click="front">上一页</el-button>
                <el-button :disabled="nextButton" type="primary" @click="next">下一页<i class="el-icon-arrow-right el-icon--right"></i>
              </el-button-group>
          </el-col>
          <el-col :span="2">
            <el-button :disabled="submitButton" type="primary" icon="el-icon-check" @click="submit">提交</el-button>
          </el-col>
        </el-row>
      </el-header>

      <el-main>
        <!-- 选课页面 -->
        <div id="fltMain">
          <div id="mapMain_sub1">
            <div>输入学期数<span style="padding-left: 10px;"></span></span></div><el-input-number v-model="NumOfSemesters" @change="SmstNumChange" :min="1" :max="10" label="输入学期数"></el-input-number>
            <div><span style="padding-left: 30px;">学期总学时数<span style="padding-left: 10px;"></span></div><el-input-number v-model="StudyHour" @change="StudyHourChange" :min="0" :max="380" label="输入学时数"></el-input-number>
          </div>
          
          <div style="padding: 20px;"></div>

          <el-upload
            class="upload-demo"
            action="./"
            :before-upload="upload"
            :limit="1"
            :on-exceed="handleExceed"
            :file-list="fileList">
            <div id="uplaod-button">
              <el-button type="primary" plain>点击解析<i class="el-icon-upload el-icon--right"></i></el-button>
              <div slot="tip" class="el-upload__tip" style="padding-left: 10px;"> 选择一个json文件以解析</div>
            </div>
          </el-upload>

          <br><br>

          <!-- 穿梭框 -->
          <!-- <el-transfer
            id="transfer"
            filterable
            filter-placeholder="输入课程关键词以搜索"
            v-model="value"
            :data="datad"
            :titles="flt_titles">
          </el-transfer> -->

          <!-- 选课表格 -->
          <el-table
            ref="multipleTable"
            :data="RawMap"
            stripe
            tooltip-effect="dark"
            style="width: 100%"
            @selection-change="handleSelectionChange">

            <el-table-column type="selection" width="55">
            </el-table-column>

            <el-table-column
              prop="name"
              label="课程名称"
              width="200"
              show-overflow-tooltip>
            </el-table-column>

            <el-table-column
              prop="time"
              label="学时"
              width="80">
            </el-table-column>

            <el-table-column
              prop="stringPre"
              label="前置课程"
              show-overflow-tooltip>
          </el-table-column>
          </el-table>
        </div>
        

        <!-- 调整顺序页面 -->
        <div id="mapMain">
          <div id="mapMain_sub1">
            <div>输入学期数<span style="padding-left: 10px;"></span></span></div><el-input-number v-model="NumOfSemesters" @change="SmstNumChange" :min="1" :max="10" label="输入学期数"></el-input-number>
            <div><span style="padding-left: 30px;">学期总学时数<span style="padding-left: 10px;"></span></div><el-input-number v-model="StudyHour" @change="StudyHourChange" :min="0" :max="380" label="输入学时数"></el-input-number>
          </div>
          <div style="padding: 20px;"></div>
          <div id="mapMain_sub2">
            <!-- <div id="paperList" v-for="table in TableData"></div> -->
            <div v-for="table in TableData" id="paperList" name="paperList">
              <div id="paperOutsideDiv" v-for="course in table" :key="course.name">
                <div id="paper" draggable="true">
                  {{course.name}}<br>
                  {{course.time}}学时
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- 生成课表页面 -->
        <div id="showMain"><h1>showMain</h1></div>
      </el-main>
    </el-container>
  </div>
</body>


<script src="https://lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<!-- Vue脚本 -->
<script>
  function printRawData(){
    vm.RawMap.forEach( course => {
      console.log(vm.RawMap);
    });
  }

  function backToFirstPage(){
    vm.active = 0;
    var a = document.getElementById("fltMain");
    var b = document.getElementById("mapMain");
    var c = document.getElementById("showMain");
    a.style.display="flex";
    b.style.display="none";
    c.style.display="none";
    vm.frontButton = true;
    vm.nextButton = false;
  }


  // 检查所选课程是否满足依赖关系，将缺失前置课的课程和所缺的课程列出
  function check(){
    alreadyHavePreCourse = [];
    warningArray = [];
    // 遍历每一列的课程数组
    vm.TableData.forEach( colCourse => {
      console.log("遍历每一列的课程数组:");
      console.log(colCourse);
      // 遍历这一列的每一个课程
      colCourse.forEach( course => {
        console.log("遍历这一列的每一个课程");
        console.log(course);
        // 遍历这个课程的每一个前置课程
        course.pre.forEach( precourse => {
          console.log("遍历这个课程的每一个前置课程");
          console.log(precourse);

          // 如果这个前置课程之前没学过，加入警告数组
          console.log("如果这个前置课程之前没学过，加入警告数组");
          if(alreadyHavePreCourse.lastIndexOf(precourse) == -1){
            console.log("alreadyHavePreCourse.lastIndexOf(precourse) == " + alreadyHavePreCourse.lastIndexOf(precourse));
            // 警告数组中如果已经存在此时所检查的课程，直接在pre数组中添加
            console.log("警告数组中如果已经存在此时所检查的课程，直接在pre数组中添加")
            var warningCourse = warningArray.filter(function(p){
              return p.name == course.name;
            });
            console.log("warningCourse.length = " + warningCourse.length)
            if(warningCourse.length > 0){
              warningCourse[0].pre.push(precourse);
            }else{
              // 如果还没有此时检查的课程，则向警告数组添加一个对象
              warningArray.push({
                name: course.name,
                pre: [precourse]
              });
            }
          }
        });
      });

      // 这一列的所有课程加入已经学过的课程
      colCourse.forEach( course =>{
        alreadyHavePreCourse.push(course.name);
      });

    })
    
    console.log(warningArray)

    if(warningArray.length == 0)return true;
    else {
      var warningMessage = "";
      warningArray.forEach( warningCourse =>{
        warningMessage = warningMessage + "您所选的课程<strong>" + warningCourse.name + "</strong>还需要前置课程:<ol>"
        warningCourse.pre.forEach( warningPreCourse => {
          warningMessage = warningMessage + "<li>" + warningPreCourse +"</li>"
        })
        warningMessage = warningMessage + "</ol>"
      })
      // 弹出错误提示
      vm.$notify.error({
        title: '您学不会啊',
        dangerouslyUseHTMLString: true,
        message: warningMessage,
        duration: 0
      });
      return false;
    }
  }

  function checkSmsStudyHour(){
    var SmsCheck = true;
    if(vm.TotalStudyHour > vm.StudyHour * vm.NumOfSemesters){
      vm.$notify.error({
        title: '超过总学时数',
        message: '总学时数'+(vm.StudyHour * vm.NumOfSemesters)+'，已选课程学时数'+(vm.TotalStudyHour)+'，超过'+(vm.TotalStudyHour - vm.StudyHour * vm.NumOfSemesters)+'学时'
      });
      SmsCheck = false;
    }
    vm.minStudyHour = vm.TotalStudyHour / vm.NumOfSemesters;
    var i = 0;
    var tmpEver = true;
    vm.TableData.forEach( SmsCourses =>{
      var ASmsStudyHour = 0;
      SmsCourses.forEach( ACourse=>{
        ASmsStudyHour += parseInt(ACourse.time);
      })
      // console.log(ASmsStudyHour);
      if(ASmsStudyHour > vm.StudyHour){
        document.getElementsByName("paperList")[i].style.background='red';
        tmpEver=false;
      }else{
        document.getElementsByName("paperList")[i].style.background='';
      }
      i += 1;
    })
    if(tmpEver)vm.EverySmsSatisfyStudyHour=true;
    else vm.EverySmsSatisfyStudyHour=false;
  }

  function divideSemester(){
    var TableData = []
    // 复制原始数组
    // var tmpMap = vm.RawMap;
    var tmpMap = [];
    // vm.RawMap.forEach( course => {
    //   tmpMap.push(course);
    // });
    vm.value.forEach( choosedCourse => {
      tmpMap.push(JSON.parse(JSON.stringify(vm.RawMap.filter(function(p){
        return p.name == choosedCourse;
      })[0])))
    })

    // 判断能否进行拓扑排序
    var warningArray = [];
    tmpMap.forEach( course => {
      course.pre.forEach( precourse => {
        var courseInTmpMap = tmpMap.filter(function(p){return p.name == precourse;});

        if(courseInTmpMap.length == 0){
          var courseInWarningArray = warningArray.filter(function(p){return p.name == course.name;});
          if(courseInWarningArray.length == 0){
            warningArray.push({
              name: course.name,
              pre: [precourse]
            })
          }else{
            courseInWarningArray[0].pre.push(precourse);
          }
        }
      })
    })
    if(warningArray.length > 0){
      var warningMessage = "";
      warningArray.forEach( warningCourse =>{
        warningMessage = warningMessage + "您所选的课程<strong>" + warningCourse.name + "</strong>还需要前置课程:<ol>"
        warningCourse.pre.forEach( warningPreCourse => {
          warningMessage = warningMessage + "<li>" + warningPreCourse +"</li>"
        })
        warningMessage = warningMessage + "</ol>"
      })
      // 弹出错误提示
      vm.$notify.error({
        title: '您学不会啊',
        dangerouslyUseHTMLString: true,
        message: warningMessage,
        duration: 0
      });
      return false;
    }


    // 拓扑排序子集划分
    while(tmpMap.length > 0){
      // 挑出所有入度为0的节点
      var ASemester = tmpMap.filter(function(p){
        return p.pre.length == 0;
      });
      TableData.push(ASemester);
      ASemester.forEach( course => {
        // 在局部图中删除所有入度为0的节点
        var courseIndex = tmpMap.lastIndexOf(course);
        tmpMap.splice(courseIndex, 1);

        // 删除所有局部图中已经不存在的入度
        // 筛选所有存在无效入度的节点
        tmpMap.filter(function(p){
          return p.pre.lastIndexOf(course.name) != -1;
        }).forEach( hasUselessCourse => {
          // 在局部图中删除这些节点pre中的无效数据
          var UselessCourseIndex = hasUselessCourse.pre.lastIndexOf(course.name);
          tmpMap[tmpMap.lastIndexOf(hasUselessCourse)].pre.splice(UselessCourseIndex, 1);
        })
      })
    }

    // 此时所有节点都没有pre数据
    // 从RawMap中添加pre数据
    TableData.forEach( colCourses => {
      colCourses.forEach( course => {
        course.pre = vm.RawMap.filter(function(p){return p.name == course.name})[0].pre;
      })
    })

    if(TableData.length > vm.NumOfSemesters){
      // 弹出错误提示
      vm.$notify.error({
        title: '您学不会啊,',
        message: "您需要"+TableData.length+"个学期学完所有课程，可是总共只有"+vm.NumOfSemesters+"个学期"
      });
      return false;
    }
    while(TableData.length < vm.NumOfSemesters){
      TableData.push([]);
    }

    vm.TableData = JSON.parse(JSON.stringify(TableData));

    return true;
  }

  var vm = new Vue({
    el: '#app',
    data: {
      flt_titles: ["可选课程","已选课程"],
      // datad: [{key:1,label:'上海'}, {key:2,label:'北京'}, {key:3,label:'广州'}, {key:4,label:'深圳'}, {key:5,label:'南京'}, {key:6,label:'西安'}, {key:7,label:'成都'}],
      // datad: (function(){
      //   d = [];
      //   courses = ['高等数学', '大学物理', '线性代数', '概率论', 'C语言', '面向对象程序设计', '人工智能导论','大魔导士导论'];
      //   courses.forEach(course => {
      //     d.push({
      //       key: course
      //     });
      //   });
      //   return d;
      // })(),
      datad: [],
      RawMap: [],

      multipleSelection: [],
      value: [],
      active: 0,
      frontButton: true,
      nextButton: false,
      submitButton: true,

      fileList:[],

      NumOfSemesters: 8,
      StudyHour: 280,
      TotalStudyHour: 0,

      Semester: [],
      TableData: [],

      EverySmsSatisfyStudyHour: false

    },
    methods: {
      submit: function(){

      },
      upload: function(file){
        // console.log(file);
        var filePath=file.path;
        //获取最后一个.的位置
        var index= filePath.lastIndexOf(".");
        //获取后缀
        var ext = filePath.substr(index+1);
        //输出结果
        console.log(ext);
        if(ext=="json"){
          console.log(file.path);
          $.ajax({
            type:'get',
            url:file.path,
            dataType:"json",
            success: function(data){
                // 获取json
                console.log(data);
                // 将json传送给内置变量
                data.courses.forEach(course => {
                  vm.datad.push({key: course.name});
                  vm.RawMap.push({
                    name: course.name,
                    time: course.time,
                    pre: course.pre,
                    stringPre: JSON.stringify(course.pre).slice(1, -1).replaceAll("\"",""),
                    next: []
                  })
                });
                // 添加每个节点的后置节点
                data.courses.forEach(course => {
                  if(course.pre.length != 0){
                    course.pre.forEach( precourse => {
                      // console.log(precourse);
                      vm.RawMap[vm.RawMap.lastIndexOf(vm.RawMap.filter(function(p){return p.name===precourse})[0])].next.push(course.name);
                    })
                  }
                })
                // 测试外置函数
                //printRawData();

                // 准备选课列表数据
            },
            error: function(data){
                alert(JSON.stringify(data));
            }
          });
        }else{
          this.$message.warning(`请选择一个json文件`);  
        }
      },

      handleExceed(files, fileList) {
        this.$message.warning(`当前限制选择 1 个文件，本次选择了 ${files.length} 个文件`);
      },

      next: function(){
        // 刷新课程拓扑排序
        if(divideSemester() == false)return;
        if(vm.TotalStudyHour > vm.StudyHour * vm.NumOfSemesters){
          vm.$notify.error({
            title: '超过总学时数',
            message: '总学时数'+(vm.StudyHour * vm.NumOfSemesters)+'，已选课程学时数'+(vm.TotalStudyHour)+'，超过'+(vm.TotalStudyHour - vm.StudyHour * vm.NumOfSemesters)+'学时'
          });
          return;
        }
        checkSmsStudyHour();

        var a = document.getElementById("fltMain");
        var b = document.getElementById("mapMain");
        var c = document.getElementById("showMain");

        b.style.visibility="visible";
        c.style.visibility="visible";

        if(a.style.display==""||a.style.display=="flex"){
          a.style.display="none";
          b.style.display="flex";
          c.style.display="none";
        }else if(b.style.display==""||b.style.display=="flex"){
          a.style.display="none";
          b.style.display="none";
          c.style.display="flex";
        }else if(c.style.display==""||c.style.display=="flex"){
          a.style.display="flex";
          b.style.display="none";
          c.style.display="none";
        }
        this.active++
        if (this.active == 2) {
          this.frontButton = false;
          this.submitButton = false;
          this.nextButton = true;
        }else{
          this.frontButton = false;
        }

      },

      front: function(){
        var a = document.getElementById("fltMain");
        var b = document.getElementById("mapMain");
        var c = document.getElementById("showMain");

        b.style.visibility="visible";
        c.style.visibility="visible";

        if(a.style.display==""||a.style.display=="flex"){
          a.style.display="none";
          b.style.display="none";
          c.style.display="flex";
        }else if(b.style.display==""||b.style.display=="flex"){
          a.style.display="flex";
          b.style.display="none";
          c.style.display="none";
        }else if(c.style.display==""||c.style.display=="flex"){
          a.style.display="none";
          b.style.display="flex";
          c.style.display="none";
        }
        this.active--;
        if (this.active == 0) {
          this.frontButton = true;
          this.nextButton = false;
        }else{
          this.nextButton = false;
        }

      },

      SmstNumChange: function(){
        if(divideSemester() == false && this.active != 0){
          this.$confirm('此操作会删除超出学期数的学期的课程, 是否继续?', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            this.$message({
              type: 'success',
              message: '删除成功!'
            });
            while(this.NumOfSemesters < this.TableData.length){
              this.TableData.pop().forEach( course =>{
                this.value.splice(this.value.lastIndexOf(course.name), 1);

                this.multipleSelection.filter(function(p){
                  return p.name == course.name;
                }).forEach( choosedCourse => {
                  this.$refs.multipleTable.toggleRowSelection(choosedCourse);
                });
              });
              divideSemester();
              
            }
          }).catch(() => {
            this.$message({
              type: 'info',
              message: '已取消删除'
            });          
            this.NumOfSemesters=this.TableData.length;
          });
        }
        checkSmsStudyHour();
      },

      StudyHourChange: function(value){
        StudyHour = value;
        // console.log(StudyHour);
        checkSmsStudyHour();
      },

      handleSelectionChange(val) {
        this.multipleSelection = val;
        var tmpvalue = [];
        var TotalStudyHour = parseInt(0);
        val.forEach( choosedCourse =>{
          tmpvalue.push(choosedCourse.name);
          TotalStudyHour = TotalStudyHour + parseInt(choosedCourse.time);          
        });
        checkSmsStudyHour();
        vm.TotalStudyHour = TotalStudyHour;
        vm.value = tmpvalue;
        // divideSemester();
      }
    },
  })
</script>


<!-- CSS样式 -->
<style>
  /* 穿梭框外框 */
  .el-transfer-panel{
  width: 500px;
  height: 500px;
  }
  /* 穿梭框内框 */
  .el-transfer-panel__list.is-filterable{
  height: 500px;
  }
  #uplaod-button{
    flex-direction: row;
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */ 
  }
  #fltMain{
    flex-direction: column;
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
  #mapMain{
    visibility: hidden;
    flex-direction: column;
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
  #mapMain_sub1{
    /* visibility: hidden; */
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
  #mapMain_sub2{
    /* visibility: hidden; */
    display: flex;
    /* flex-direction: column; */
    justify-content: center; /* 水平居中 */
    /* align-items: center;     垂直居中 */
  }
  #paperList{
    display: flex;
    flex: 1;
    flex-direction: column;
    border-left: dashed black;
    justify-content: center; 
    align-items: center;     
  }
  #paperList:first-child{
    flex-direction: column;
    border-left: none;
    display: flex;
    flex: 1;
    /* justify-content: center; 水平居中 */
    /* align-items: center;     垂直居中 */
  }
  #paperList #paperOutsideDiv{
    padding: 20px;
    align-items: center;
  }
  #paper{
    display: flex;
    border-style: double;
    border-radius: 10px;
    border-color: black;
    padding: 5px;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
    background: #ffffff;
  }
  #showMain{
    visibility: hidden;
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
  #app{
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
  .el-row{
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
  .el-col-4{
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
  .el-col-2{
    display: flex;
    justify-content: center; /* 水平居中 */
    align-items: center;     /* 垂直居中 */
  }
</style>

</html>